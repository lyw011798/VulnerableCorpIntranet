# Vulnerability Report: CorpIntranet Profile Manager

## 1. Environment Description
The application is a **Flask (Python)** web application running in a **Dockerized environment**.
- **Framework**: Flask 2.x (Python 3.9)
- **Database**: SQLite (local file `database.db`)
- **Containerization**: Docker & Docker Compose
- **Frontend**: HTML5, CSS3, Vanilla JavaScript
- **Local Setup**: The application runs on `http://localhost:5000`.

## 2. Vulnerability Description
**Vulnerability Type**: Mass Assignment (also known as Object Injection or Auto-Binding).

**Affected Component**:
- **File**: `app/app.py`
- **Function**: `update_profile_vulnerable` (mapped to `/api/profile/update`)
- **Line Range (Original)**: Lines 63-67 (approximate)

**Description**:
The application implemented a profile update feature that blindly accepted all keys provided in the JSON request body and assigned them to the `User` database object using a loop and `setattr`.
```python
# Vulnerable Code Snippet
for key, value in data.items():
    if hasattr(user, key):
        setattr(user, key, value) # <--- Vulnerability
```

**Risk Level**: **High (Critical)**
- **Impact**: Privilege Escalation.
- **Exploit**: An attacker can inject a `"role": "admin"` key-value pair into the update request. The application processes this key and updates the user's role in the database, granting administrative privileges.

## 3. Proposed Fixes
**Remediation Strategy**: Implement a **Whitelist** (Strict Input Validation).
Instead of iterating through all provided keys, the application should only explicitly update fields that are safe and allowed to be modified by the user (e.g., `email`).

**Secure Code Snippet (`app/app.py`)**:
```python
# SECURE IMPLEMENTATION: Whitelist approach
# Only allow specific fields to be updated
if 'email' in data:
    user.email = data['email']
        
# 'role' and other sensitive fields are explicitly ignored
db.session.commit()
```

**Why it is Secure**:
This approach ensures that sensitive fields like `role`, `password_hash`, or `id` cannot be modified by the user, regardless of what they send in the request body. The application dictates what can be changed, not the user input.

## 4. Verification & Reflection
**Verification Steps**:
1.  **Before Fix**:
    - Sent `POST /api/profile/update` with `{"role": "admin"}`.
    - **Result**: User role changed to `admin`. Privilege escalation successful.
2.  **After Fix**:
    - Applied the whitelist patch.
    - Sent `POST /api/profile/update` with `{"role": "admin"}`.
    - **Result**: User role remained `user`. The `role` field was ignored.
    - **Confirmation**: Verified via Dashboard UI and API response.

**Reflection**:
This vulnerability highlights the danger of trusting user input and using convenience methods (like dynamic attribute assignment) without proper safeguards. Explicitly defining allowed input (whitelisting) is a fundamental security principle that effectively neutralizes this class of attacks.
